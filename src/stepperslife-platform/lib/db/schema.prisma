// SteppersLife Unified Platform - Prisma Schema
// Clean architecture with modular design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE SYSTEM - Always Active
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials login
  role          UserRole  @default(USER)

  // User preferences
  preferences   Json?     // { showEvents: true, showStore: true }

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Core relations
  accounts      Account[]
  sessions      Session[]

  // Module relations (optional - only if module enabled)
  events            Event[]             // Events module
  eventStaff        EventStaff[]        // Events module
  tickets           Ticket[]            // Events module
  eventOrders       EventOrder[]        // Events module
  vendorStores      VendorStore[]       // Store module
  storeOrders       StoreOrder[]        // Store module
  productReviews    ProductReview[]     // Store module
  vendorFollowers   VendorFollower[]    // Store module
  shoppingCart      ShoppingCart?       // Store module

  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN           // Platform administrator
  USER            // Regular user
  EVENT_ORGANIZER // Can create events
  VENDOR          // Can create stores
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// FEATURE FLAG SYSTEM - Module Management
// ============================================================================

model FeatureFlag {
  id          String   @id @default(cuid())
  name        String   @unique  // "events", "store", "blog"
  enabled     Boolean  @default(false)
  description String?

  // Configuration
  routes      Json?    // Array of routes this feature owns
  permissions Json?    // Required permissions
  config      Json?    // Module-specific configuration

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("feature_flags")
}

// ============================================================================
// EVENTS MODULE - Event Ticketing System
// ============================================================================

model Event {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String?

  // Event details
  startDate       DateTime
  endDate         DateTime
  location        String?
  imageUrl        String?

  // Event type
  eventType       EventType @default(TICKETED_EVENT)

  // Categories
  categories      String[]  @default([])

  // Organizer
  organizerId     String
  organizer       User      @relation(fields: [organizerId], references: [id])

  // Status
  status          EventStatus @default(DRAFT)
  isPublished     Boolean   @default(false)
  isFeatured      Boolean   @default(false)

  // Settings
  capacity        Int?
  allowWaitlist   Boolean   @default(false)
  allowTransfers  Boolean   @default(true)

  // Pricing
  ticketTypes     TicketType[]

  // Staff
  staff           EventStaff[]

  // Tickets
  tickets         Ticket[]

  // Orders
  orders          EventOrder[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizerId])
  @@index([status])
  @@index([startDate])
  @@map("events")
}

enum EventType {
  SAVE_THE_DATE
  FREE_EVENT
  TICKETED_EVENT
  SEATED_EVENT
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

model TicketType {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  quantity    Int
  sold        Int      @default(0)

  // Sales window
  saleStart   DateTime?
  saleEnd     DateTime?

  isActive    Boolean  @default(true)

  tickets     Ticket[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([eventId])
  @@map("ticket_types")
}

model Ticket {
  id            String   @id @default(cuid())
  ticketNumber  String   @unique

  eventId       String
  event         Event    @relation(fields: [eventId], references: [id])

  ticketTypeId  String
  ticketType    TicketType @relation(fields: [ticketTypeId], references: [id])

  orderId       String?
  order         EventOrder? @relation(fields: [orderId], references: [id])

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  attendeeEmail String?
  attendeeName  String?

  status        TicketStatus @default(VALID)
  scannedAt     DateTime?
  scannedBy     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([eventId])
  @@index([userId])
  @@index([ticketNumber])
  @@index([orderId])
  @@map("tickets")
}

enum TicketStatus {
  VALID
  SCANNED
  CANCELLED
  REFUNDED
  PENDING_ACTIVATION
}

model EventStaff {
  id              String   @id @default(cuid())
  eventId         String
  userId          String

  event           Event    @relation(fields: [eventId], references: [id])
  user            User     @relation(fields: [userId], references: [id])

  role            StaffRole
  permissions     Json?    // Custom permissions

  // Scanning permissions
  canScan         Boolean  @default(false)

  // Commission
  commissionPercent Decimal? @db.Decimal(5, 2)
  commissionEarned  Decimal  @default(0) @db.Decimal(10, 2)

  // Status
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@map("event_staff")
}

enum StaffRole {
  ORGANIZER
  STAFF
  TEAM_MEMBER
  ASSOCIATE
}

// Event Orders - Ticket Purchases
model EventOrder {
  id              String   @id @default(cuid())
  orderNumber     String   @unique

  // Event
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id])

  // Buyer
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  buyerName       String
  buyerEmail      String
  buyerPhone      String?

  // Tickets
  tickets         Ticket[]

  // Pricing (in cents)
  subtotalCents   Int
  platformFeeCents Int     @default(0)
  processingFeeCents Int   @default(0)
  totalCents      Int

  // Status
  status          EventOrderStatus @default(PENDING)

  // Payment
  paymentMethod   String?
  paymentIntentId String?
  paidAt          DateTime?

  // Staff referral
  soldByStaffId   String?
  referralCode    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([eventId])
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("event_orders")
}

enum EventOrderStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
  REFUNDED
}

// ============================================================================
// STORE MODULE - Multi-Vendor E-commerce System
// ============================================================================

// Vendor Store - Each vendor has their own independent store
model VendorStore {
  id                        String              @id @default(cuid())
  storeId                   String              @unique
  userId                    String
  name                      String
  slug                      String              @unique
  tagline                   String?             @db.VarChar(100)
  description               String?
  logoUrl                   String?
  bannerUrl                 String?
  email                     String
  phone                     String?

  // Shipping
  shipFromAddress           Json?
  shippingRates             Json?

  // Payment Processors
  stripeAccountId           String?             @unique
  stripeChargesEnabled      Boolean             @default(false)
  stripeDetailsSubmitted    Boolean             @default(false)
  primaryPaymentProcessor   PaymentProcessor    @default(STRIPE)
  secondaryPaymentProcessor PaymentProcessor?
  paypalEmail               String?
  paypalMerchantId          String?
  squareAccessToken         String?
  squareLocationId          String?
  acceptsCash               Boolean             @default(false)
  cashInstructions          String?

  // Vendor Payouts
  withdrawBalance           Decimal             @default(0) @db.Decimal(12, 2)
  withdrawMethod            WithdrawMethod?
  bankAccountDetails        Json?
  minimumWithdraw           Decimal             @default(50) @db.Decimal(10, 2)

  // Platform Fees
  platformFeePercent        Decimal             @default(7.0) @db.Decimal(5, 2)

  // Stats
  totalProducts             Int                 @default(0)
  totalOrders               Int                 @default(0)
  totalSales                Decimal             @default(0) @db.Decimal(12, 2)
  averageRating             Decimal?            @db.Decimal(3, 2)
  totalReviews              Int                 @default(0)

  // Status
  isActive                  Boolean             @default(true)
  isVerified                Boolean             @default(false)
  verifiedAt                DateTime?

  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @default(now())

  // Relations
  owner                     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  products                  Product[]
  storeOrders               StoreOrder[]
  coupons                   Coupon[]
  productReviews            ProductReview[]
  shopRating                ShopRating?
  storeHours                StoreHours?
  storeVacations            StoreVacation[]
  shippingZones             ShippingZone[]
  vendorWithdraws           VendorWithdraw[]
  vendorFollowers           VendorFollower[]
  orderPromotions           OrderPromotion[]
  abandonedCarts            AbandonedCart[]
  announcementReads         AnnouncementRead[]

  @@index([userId])
  @@index([slug])
  @@index([isActive])
  @@map("vendor_stores")
}

// Product - Supports simple variants and multi-variant combinations
model Product {
  id                   String              @id @default(cuid())
  vendorStoreId        String
  name                 String
  slug                 String
  description          String
  price                Decimal             @db.Decimal(10, 2)
  compareAtPrice       Decimal?            @db.Decimal(10, 2)

  // Inventory
  sku                  String?
  quantity             Int                 @default(0)
  trackInventory       Boolean             @default(true)
  lowStockThreshold    Int                 @default(5)

  // Categorization
  category             ProductCategory
  tags                 String[]

  // Multi-variant System
  hasVariants          Boolean             @default(false)
  useMultiVariants     Boolean             @default(false)
  variantTypes         String[]            @default([]) // e.g., ["Size", "Color"]

  // SEO
  metaTitle            String?             @db.VarChar(60)
  metaDescription      String?             @db.VarChar(160)

  // Status
  status               ProductStatus       @default(DRAFT)
  publishedAt          DateTime?

  // Stats
  viewCount            Int                 @default(0)
  salesCount           Int                 @default(0)
  averageRating        Decimal?            @db.Decimal(3, 2)
  reviewCount          Int                 @default(0)

  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @default(now())

  // Relations
  vendorStore          VendorStore         @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  productImages        ProductImage[]
  productVariants      ProductVariant[]
  variantCombinations  VariantCombination[]
  variantOptions       VariantOption[]
  productAddons        ProductAddon[]
  productReviews       ProductReview[]
  storeOrderItems      StoreOrderItem[]
  orderPromotions      OrderPromotion[]
  cartItems            CartItem[]

  @@unique([vendorStoreId, slug])
  @@index([vendorStoreId, status])
  @@index([category, status])
  @@map("products")
}

// Simple Product Variants (e.g., Size: Small, Medium, Large)
model ProductVariant {
  id        String     @id @default(cuid())
  productId String
  name      String     // e.g., "Size"
  value     String     // e.g., "Large"
  price     Decimal?   @db.Decimal(10, 2)
  sku       String?
  quantity  Int        @default(0)
  imageUrl  String?
  available Boolean    @default(true)
  sortOrder Int        @default(0)

  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems CartItem[]

  @@index([productId, available])
  @@map("product_variants")
}

// Multi-Variant Combinations (e.g., Small-Red, Large-Blue)
model VariantCombination {
  id                String   @id @default(cuid())
  productId         String
  combinationKey    String   // e.g., "size-small_color-red"
  optionValues      Json     // {"Size": "Small", "Color": "Red"}
  sku               String?
  price             Decimal? @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  quantity          Int      @default(0)
  quantityAvailable Int?
  quantityOnHold    Int      @default(0)
  quantityCommitted Int      @default(0)
  inventoryTracked  Boolean  @default(true)
  lowStockThreshold Int?
  available         Boolean  @default(true)
  inStock           Boolean  @default(true)
  imageUrl          String?
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, combinationKey])
  @@index([productId, available])
  @@index([productId, inStock])
  @@map("variant_combinations")
}

// Variant Options (defines available options for each variant type)
model VariantOption {
  id          String   @id @default(cuid())
  productId   String
  type        String   // e.g., "Size", "Color"
  value       String   // e.g., "Small", "Red"
  displayName String
  hexColor    String?  // For color variants
  imageUrl    String?
  icon        String?
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, isActive])
  @@index([productId, type])
  @@map("variant_options")
}

// Product Images
model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  thumbnail String?
  medium    String?
  large     String?
  altText   String?
  sortOrder Int      @default(0)

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// Product Add-ons (optional extras like gift wrapping, engraving)
model ProductAddon {
  id            String   @id @default(cuid())
  productId     String?
  storeId       String
  name          String
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  isRequired    Boolean  @default(false)
  allowMultiple Boolean  @default(false)
  maxQuantity   Int?
  imageUrl      String?
  isActive      Boolean  @default(true)

  product       Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, isActive])
  @@index([storeId, isActive])
  @@map("product_addons")
}

// Product Reviews
model ProductReview {
  id                 String         @id @default(cuid())
  productId          String
  orderItemId        String         @unique
  customerId         String?
  vendorStoreId      String
  rating             Int            // 1-5
  title              String?        @db.VarChar(100)
  review             String
  photoUrls          String[]
  isVerifiedPurchase Boolean        @default(true)
  customerName       String
  customerEmail      String
  vendorResponse     String?
  vendorRespondedAt  DateTime?
  status             ReviewStatus   @default(PUBLISHED)
  helpfulCount       Int            @default(0)
  unhelpfulCount     Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @default(now())

  // Relations
  customer           User?          @relation(fields: [customerId], references: [id], onDelete: SetNull)
  product            Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendorStore        VendorStore    @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  storeOrderItem     StoreOrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([productId, status, createdAt])
  @@index([vendorStoreId, createdAt])
  @@map("product_reviews")
}

// Shop-wide Rating Summary
model ShopRating {
  id             String        @id @default(cuid())
  vendorStoreId  String        @unique
  averageRating  Decimal       @db.Decimal(3, 2)
  totalReviews   Int           @default(0)
  fiveStars      Int           @default(0)
  fourStars      Int           @default(0)
  threeStars     Int           @default(0)
  twoStars       Int           @default(0)
  oneStar        Int           @default(0)
  lastCalculated DateTime      @default(now())
  updatedAt      DateTime      @default(now())

  vendorStore    VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@map("shop_ratings")
}

// Shopping Cart
model ShoppingCart {
  id        String     @id @default(cuid())
  userId    String     @unique
  subtotal  Decimal    @default(0) @db.Decimal(10, 2)
  tax       Decimal    @default(0) @db.Decimal(10, 2)
  total     Decimal    @default(0) @db.Decimal(10, 2)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
  @@map("shopping_carts")
}

// Cart Items
model CartItem {
  id        String        @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int           @default(1)
  price     Decimal       @db.Decimal(10, 2)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  cart      ShoppingCart  @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
  @@index([variantId])
  @@map("cart_items")
}

// Store Orders
model StoreOrder {
  id                String                   @id @default(cuid())
  orderNumber       String                   @unique
  vendorStoreId     String
  customerId        String?
  customerEmail     String
  customerName      String
  customerPhone     String?

  // Addresses
  shippingAddress   Json
  billingAddress    Json

  // Pricing
  subtotal          Decimal                  @db.Decimal(10, 2)
  shippingCost      Decimal                  @db.Decimal(10, 2)
  taxAmount         Decimal                  @db.Decimal(10, 2)
  discountAmount    Decimal                  @default(0) @db.Decimal(10, 2)
  total             Decimal                  @db.Decimal(10, 2)
  platformFee       Decimal                  @db.Decimal(10, 2)
  vendorPayout      Decimal                  @db.Decimal(10, 2)

  // Payment
  paymentProcessor  PaymentProcessor         @default(STRIPE)
  paymentIntentId   String?                  @unique
  paymentStatus     MarketplacePaymentStatus @default(PENDING)
  paidAt            DateTime?

  // Fulfillment
  fulfillmentStatus FulfillmentStatus        @default(UNFULFILLED)
  shippingMethod    String?
  trackingNumber    String?
  carrier           String?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  // Status
  status            MarketplaceOrderStatus   @default(PENDING)
  customerNotes     String?
  internalNotes     String?

  // Cancellation & Refunds
  cancelledAt       DateTime?
  cancelReason      String?
  refundedAt        DateTime?
  refundAmount      Decimal?                 @db.Decimal(10, 2)

  // Coupon
  couponCode        String?
  couponId          String?

  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @default(now())

  // Relations
  storeOrderItems   StoreOrderItem[]
  coupon            Coupon?                  @relation(fields: [couponId], references: [id], onDelete: SetNull)
  customer          User?                    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  vendorStore       VendorStore              @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@index([vendorStoreId, createdAt])
  @@index([vendorStoreId, status, createdAt])
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([couponId])
  @@index([createdAt])
  @@map("store_orders")
}

// Store Order Items
model StoreOrderItem {
  id                   String          @id @default(cuid())
  storeOrderId         String
  productId            String
  variantId            String?
  name                 String
  sku                  String?
  price                Decimal         @db.Decimal(10, 2)
  quantity             Int
  variantName          String?
  imageUrl             String?
  addons               Json?
  variantCombinationId String?
  variantDetails       Json?
  createdAt            DateTime        @default(now())

  // Relations
  productReview        ProductReview?
  product              Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  storeOrder           StoreOrder      @relation(fields: [storeOrderId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([storeOrderId])
  @@map("store_order_items")
}

// Discount Coupons
model Coupon {
  id                     String        @id @default(cuid())
  vendorStoreId          String
  code                   String
  description            String?
  discountType           DiscountType
  discountValue          Decimal       @db.Decimal(10, 2)
  minPurchaseAmount      Decimal?      @db.Decimal(10, 2)
  maxDiscountAmount      Decimal?      @db.Decimal(10, 2)
  usageLimit             Int?
  usageCount             Int           @default(0)
  perCustomerLimit       Int?
  startDate              DateTime?
  endDate                DateTime?
  isActive               Boolean       @default(true)
  applicableProducts     String[]
  applicableCategories   String[]
  excludedProducts       String[]
  firstTimeCustomersOnly Boolean       @default(false)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @default(now())

  // Relations
  vendorStore            VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  storeOrders            StoreOrder[]

  @@unique([vendorStoreId, code])
  @@index([vendorStoreId, isActive])
  @@map("coupons")
}

// Shipping Zones (geographic areas)
model ShippingZone {
  id             String         @id @default(cuid())
  vendorStoreId  String
  name           String
  regions        Json           // Array of countries/states
  isEnabled      Boolean        @default(true)
  priority       Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now())

  // Relations
  vendorStore    VendorStore    @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  shippingRates  ShippingRate[]

  @@index([vendorStoreId, isEnabled])
  @@map("shipping_zones")
}

// Shipping Rates per Zone
model ShippingRate {
  id             String       @id @default(cuid())
  zoneId         String
  name           String
  type           ShippingType
  cost           Decimal      @db.Decimal(10, 2)
  minOrderAmount Decimal?     @db.Decimal(10, 2)
  isEnabled      Boolean      @default(true)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())

  // Relations
  shippingZone   ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, isEnabled])
  @@map("shipping_rates")
}

// Store Operating Hours
model StoreHours {
  id            String        @id @default(cuid())
  vendorStoreId String        @unique
  monday        Json?
  tuesday       Json?
  wednesday     Json?
  thursday      Json?
  friday        Json?
  saturday      Json?
  sunday        Json?
  timezone      String        @default("America/New_York")
  isEnabled     Boolean       @default(true)

  vendorStore   VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@map("store_hours")
}

// Store Vacations/Closures
model StoreVacation {
  id            String        @id @default(cuid())
  vendorStoreId String
  startDate     DateTime
  endDate       DateTime
  message       String?
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())

  vendorStore   VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@index([vendorStoreId, startDate])
  @@index([vendorStoreId, isActive])
  @@map("store_vacations")
}

// Vendor Payout Requests
model VendorWithdraw {
  id            String         @id @default(cuid())
  vendorStoreId String
  amount        Decimal        @db.Decimal(10, 2)
  method        WithdrawMethod
  status        WithdrawStatus @default(PENDING)
  requestedAt   DateTime       @default(now())
  processedAt   DateTime?
  notes         String?
  adminNotes    String?
  bankDetails   Json?

  vendorStore   VendorStore    @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@index([vendorStoreId, status])
  @@index([status, requestedAt])
  @@map("vendor_withdraws")
}

// Customer Follows Store
model VendorFollower {
  id               String        @id @default(cuid())
  vendorStoreId    String
  customerId       String
  followedAt       DateTime      @default(now())
  notifyNewProducts Boolean      @default(true)
  notifySales      Boolean       @default(true)

  vendorStore      VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  customer         User          @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([vendorStoreId, customerId])
  @@index([customerId])
  @@index([vendorStoreId])
  @@map("vendor_followers")
}

// Abandoned Cart Recovery
model AbandonedCart {
  id                   String        @id @default(cuid())
  cartSessionId        String        @unique
  vendorStoreId        String
  customerEmail        String?
  customerName         String?
  cartData             Json
  cartTotal            Decimal       @db.Decimal(10, 2)
  itemCount            Int
  recoveryToken        String        @unique @default(cuid())
  reminderSentAt       DateTime?
  secondReminderSentAt DateTime?
  thirdReminderSentAt  DateTime?
  recoveredAt          DateTime?
  isRecovered          Boolean       @default(false)
  discountCode         String?       @unique
  discountPercent      Int           @default(10)
  discountCodeUsed     Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @default(now())
  expiresAt            DateTime

  vendorStore          VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@index([vendorStoreId, isRecovered])
  @@index([customerEmail])
  @@index([expiresAt])
  @@index([discountCode])
  @@index([reminderSentAt])
  @@map("abandoned_carts")
}

// Order Promotions (Upsells, Cross-sells, Order Bumps)
model OrderPromotion {
  id            String          @id @default(cuid())
  vendorStoreId String
  type          PromotionType
  title         String
  description   String?
  productId     String
  variantId     String?
  discountType  DiscountType
  discountValue Decimal         @db.Decimal(10, 2)
  freeShipping  Boolean         @default(false)
  status        PromotionStatus @default(ACTIVE)
  priority      Int             @default(0)
  conditions    Json?
  displayCount  Int             @default(0)
  acceptedCount Int             @default(0)
  revenueAdded  Decimal         @default(0) @db.Decimal(12, 2)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now())

  vendorStore   VendorStore     @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([vendorStoreId, status])
  @@index([status, priority])
  @@map("order_promotions")
}

// Admin Announcements to Vendors
model Announcement {
  id                String             @id @default(cuid())
  title             String
  content           String
  targetType        AnnouncementTarget
  targetVendors     String[]
  status            AnnouncementStatus @default(DRAFT)
  publishAt         DateTime?
  createdAt         DateTime           @default(now())
  createdBy         String

  announcementReads AnnouncementRead[]

  @@index([status, publishAt])
  @@index([createdBy])
  @@map("announcements")
}

// Track who read announcements
model AnnouncementRead {
  id             String        @id @default(cuid())
  announcementId String
  vendorStoreId  String
  readAt         DateTime      @default(now())

  announcement   Announcement  @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  vendorStore    VendorStore   @relation(fields: [vendorStoreId], references: [id], onDelete: Cascade)

  @@unique([announcementId, vendorStoreId])
  @@index([vendorStoreId, readAt])
  @@map("announcement_reads")
}

// ============================================================================
// STORE MODULE ENUMS
// ============================================================================

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum ProductCategory {
  ACCESSORIES
  ART_AND_COLLECTIBLES
  BAGS_AND_PURSES
  BATH_AND_BEAUTY
  BOOKS_MOVIES_AND_MUSIC
  CLOTHING
  CRAFT_SUPPLIES_AND_TOOLS
  ELECTRONICS_AND_ACCESSORIES
  HOME_AND_LIVING
  JEWELRY
  PAPER_AND_PARTY_SUPPLIES
  PET_SUPPLIES
  SHOES
  TOYS_AND_GAMES
  WEDDINGS
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum PaymentProcessor {
  STRIPE
  PAYPAL
  SQUARE
  CASH
}

enum MarketplaceOrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum MarketplacePaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}

enum ReviewStatus {
  PUBLISHED
  FLAGGED
  HIDDEN
  DELETED
}

enum ShippingType {
  FLAT_RATE
  FREE_SHIPPING
  WEIGHT_BASED
  LOCAL_PICKUP
}

enum WithdrawMethod {
  BANK_TRANSFER
  PAYPAL
  STRIPE
  SKRILL
}

enum WithdrawStatus {
  PENDING
  APPROVED
  PROCESSING
  PAID
  CANCELLED
  REJECTED
}

enum PromotionType {
  ORDER_BUMP
  UPSELL
  CROSS_SELL
}

enum PromotionStatus {
  ACTIVE
  INACTIVE
  SCHEDULED
  EXPIRED
}

enum AnnouncementTarget {
  ALL_VENDORS
  SPECIFIC_VENDORS
}

enum AnnouncementStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}
